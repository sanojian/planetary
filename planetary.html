<!DOCTYPE html>
<!--
	Copyright 2013 Jonas 'sanojian' Olmstead
-->
<html>
    <head>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
		<title>Raph game test</title>
		<script type="text/javascript" src="./includes/raphael2.js"></script>
		<script type="text/javascript" src="./includes/buzz.js"></script>
		<!--script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script-->

<script type="text/javascript">
if (typeof jQuery == 'undefined')
{
	// fallback to local if google cdn no workie
    document.write(unescape("%3Cscript src='./includes/jQuery.js' type='text/javascript'%3E%3C/script%3E"));
}
</script>        
        <script language="javascript">

		
		
var g_levels = {
	level1: {
		planets: {	'A': { name: 'A', x: 200, y: 200, r: 20, color: '#ff00ff' },
					'B': { name: 'B', x: 300, y: 400, r: 22, color: '#009966' }
		},
		routes: [ 'A_B' ],
		players: [
			{ team: 'team1', location: 'A' },
			{ team: 'team2', location: undefined }
		],
		ships: [
			{ team: 'team2', type: 'fighter', location: 'B' }
		],
		tutorial_image: { 	name: 'level1.png', x: 400, y: 200, w: 400, h: 300,
							text: 'LEVEL 1:\n \nOrder your fighters\nto attack the enemy\nby dragging from\none planet to\nthe other',
							tx: 250, ty: 130
		}
		
		
	},
	level2: {
		planets: {	'A': { name: 'A', x: 100, y: 100, r: 20, color: '#ff00ff' },
					'B': { name: 'B', x: 200, y: 300, r: 17, color: '#009966' },
					'C': { name: 'C', x: 500, y: 400, r: 25, color: '#ff9999' },
					'D': { name: 'D', x: 700, y: 400, r: 18, color: '#960596' },
					'E': { name: 'E', x: 800, y: 300, r: 19, color: '#4598DD' },
					'F': { name: 'F', x: 400, y: 600, r: 22, color: '#9845DD' },
					'G': { name: 'G', x: 600, y: 200, r: 24, color: '#989233' },
		},
		routes: [ 'A_B', 'B_C', 'C_D', 'D_E', 'C_F', 'C_G' ],
		players: [
			{ team: 'team1', location: 'C' },
			{ team: 'team2', location: 'A' },
		],
		ships: []
	}
};
		
var g_defs = {
				teams: {
					team1: { color: '#228DFF' },
					team2: { color: '#FF0092' },
					team3: { color: '#FFCA1B' },
					team4: { color: '#BA01FF' },
					team5: { color: '#B6FF00' }
				},
				shipStats: {
					fighter: {
						damage: 0.5,
						hits: 2,
						speed: 3
					},
					bomber: {
						damage: 0.2,
						hits: 2,
						speed: 2
					},
					factory: {
						damage: 0,
						hits: 2,
						speed: 1.5
					}
				
				}
};
		
var g_game = {
				ships: [],
				planets: {},
				routes: {},
				buildings: {},
				teams: {},
				explosions: [],
				sounds: {},
				music: {}
};
		
$(document).ready(function() {

	g_game.sounds.bomber = new buzz.sound( "./audio/fx/bomb", {
		formats: [ "ogg", "wav" ]
	});
	g_game.sounds.laser = new buzz.sound( "./audio/fx/laser", {
		formats: [ "wav" ]
	});
 	g_game.sounds.explosion = new buzz.sound( "./audio/fx/explosion", {
		formats: [ "wav" ]
	});
 	g_game.music.song1 = new buzz.sound( "//dl.dropbox.com/u/102070389/games/planetary/Clearside - Assimilator", {
		formats: [ "mp3" ],
	});
	g_game.music.song1.play().loop();

	if (!localStorage.planetary_level) {
		localStorage.planetary_level = 1;
	}
	g_game.level = 'level' + localStorage.planetary_level;
	console.log(g_game.level);
	
	$('#gameHolder').width($(document).width()-32).height($(document).height()-32);
	g_game.raphPaper = Raphael("gameHolder");
	g_game.shipSelector = g_game.raphPaper.set();
	g_game.shipSelector.push(g_game.raphPaper.circle(0, 0, 40).attr({ stroke: '#999', 'stroke-width': 2 }));
	g_game.shipSelector.push(drawShip('fighter', 6, g_defs.teams['team1'].color, 0, -38));
	g_game.shipSelector.push(drawShip('bomber', 6, g_defs.teams['team1'].color, 36, 0));
	g_game.shipSelector.push(drawShip('factory', 6, g_defs.teams['team1'].color, 0, 38));
	g_game.shipSelector[1].hover(function() { if (g_game.shipSelector.game.factory) g_game.shipSelector.game.factory.buildType = 'fighter'; });
	g_game.shipSelector[2].hover(function() { if (g_game.shipSelector.game.factory) g_game.shipSelector.game.factory.buildType = 'bomber'; });
	g_game.shipSelector[3].hover(function() { if (g_game.shipSelector.game.factory) g_game.shipSelector.game.factory.buildType = 'factory'; });
	g_game.shipSelector.game = {};
	g_game.shipSelector.hide();
		
	g_game.background = g_game.raphPaper.rect(0,0,2048,2048,12).attr( { stroke: '#eeeeee', fill: '#eeeeee', opacity: 0.02 });
	g_game.background.game = { vx: 0, vy: 0 };
	g_game.background.drag(
		function(dx, dy, x, y, evt) {
			this.game.vx = this.game.ox - dx;
			this.game.vy = this.game.oy - dy;
			positionGameText();
			g_game.raphPaper.setViewBox(this.game.vx, this.game.vy, g_game.raphPaper.width, g_game.raphPaper.height);
		}, function(x, y, evt) {
			this.game.ox = this.game.vx || 0;
			this.game.oy = this.game.vy || 0;
		}, function() {
		}
	);
	g_game.raphPaper.setViewBox(0, 0, $('#gameHolder').width(), $('#gameHolder').height());

	g_game.gameMessage = g_game.raphPaper.set([
		g_game.raphPaper.text(0, 0, 'The message').attr({ stroke: '#ffffff', font: '32px Arial' }),
		g_game.raphPaper.text(0, 0, '<- prev lvl').attr({ stroke: '#ffffff', font: '24px Arial',  href: 'javascript: console.log("prev")' }),
		g_game.raphPaper.text(0, 0, '@ restart').attr({ stroke: '#ffffff', font: '24px Arial' }),
		g_game.raphPaper.text(0, 0, 'next lvl ->').attr({ stroke: '#ffffff', font: '24px Arial',  href: 'javascript: location.href = location.href' })
	]).hide();
	g_game.gameMessage.game = { show: false, positions: [[0, -40], [-200, 60], [0, 60], [200, 60]] };

	g_game.routeSelector = g_game.raphPaper.path('M0 0L10 10').attr({ stroke: '#B6FF00', 'stroke-width': 4 });
	g_game.routeSelector.toBack().hide();
	g_game.routeSelector.game = { isActive: false, points: [] };

	// load level
	var level = undefined;
	level = g_levels['level' + localStorage.planetary_level];
	while (!level) {
		localStorage.planetary_level = parseInt(localStorage.planetary_level, 10) - 1;
		console.log('down to ' + localStorage.planetary_level);
		level = g_levels['level' + localStorage.planetary_level];
	}
	for (var name in level.planets) {
		g_game.planets[name] = new Planet(name, level.planets[name].x, level.planets[name].y, level.planets[name].r, level.planets[name].color);
	}
	for (var i=0;i<level.routes.length;i++) {
		var route = level.routes[i].split('_');
		g_game.routes[level.routes[i]] = new Route(route[0], route[1]);
	}
	for (var i=0;i<level.players.length;i++) {
		initTeam(level.players[i].team, level.players[i].location);
	}
	for (var i=0;i<level.ships.length;i++) {
		var planet = g_game.planets[level.ships[i].location];
		g_game.ships.push(new Ship(level.ships[i].type, level.ships[i].team, planet.x, planet.y, 3, planet.name));
	}
	if (level.tutorial_image) {
		g_game.tutorial_set = g_game.raphPaper.set([
			g_game.raphPaper.text(0, 0, level.tutorial_image.text).attr( { stroke: '#ffffff', font: '24px Arial', 'vertical-align': 'bottom' } ),
			g_game.raphPaper.rect(level.tutorial_image.x, level.tutorial_image.y, level.tutorial_image.w, level.tutorial_image.h, 12)
				.attr({ fill: '#ffff00', opacity: 0.3 }),
			g_game.raphPaper.image('./images/tutorial/' + level.tutorial_image.name, 
								level.tutorial_image.x,
								level.tutorial_image.y,
								level.tutorial_image.w,
								level.tutorial_image.h)
								
		]).toBack();
		g_game.tutorial_set[0].game = { tx: level.tutorial_image.tx, ty: level.tutorial_image.ty };
	}

	positionGameText();
	doGameLoop(0);
	
});

var initTeam = function(team, home) {
	g_game.teams[team] = { routePoints: [] };
	if (home) {
		g_game.buildings[home] = new Factory(home, team);
	}
	if (team != 'team1') {
		g_game.teams[team].player = new PlayerAI(team);
	}
};

var Explosion = function(image) {

	var color = (image.attrs || image[0].attrs).fill;
	var bbox = image.getBBox();
	var x = bbox.x + bbox.width/2;
	var y = bbox.y + bbox.height/2;
	var block1 = g_game.raphPaper.rect(x-3,y-3,3,3).attr({ fill: color, stroke: '#ddd', 'stroke-width': 1 });
	var block2 = g_game.raphPaper.rect(x,y-3,3,3).attr({ fill: color, stroke: '#ddd', 'stroke-width': 1 });
	var block3 = g_game.raphPaper.rect(x-3,y,3,3).attr({ fill: color, stroke: '#ddd', 'stroke-width': 1 });
	var block4 = g_game.raphPaper.rect(x,y,3,3).attr({ fill: color, stroke: '#ddd', 'stroke-width': 1 });

	var blocks = [block1, block2, block3, block4];
	var dx1 = 1 + Math.random() * 2;
	var dx2 = 1 + Math.random() * 2;
	var dx3 = 1 + Math.random() * 2;
	var dx4 = 1 + Math.random() * 2;
	var dy1 = 1 + Math.random() * 2;
	var dy2 = 1 + Math.random() * 2;
	var dy3 = 1 + Math.random() * 2;
	var dy4 = 1 + Math.random() * 2;

	g_game.sounds.explosion.play();
 
	var time = 0;
	this.animate = function() {

		if (time > 10) {
			blocks[0].remove();
			blocks[1].remove();
			blocks[2].remove();
			blocks[3].remove();
			return false;
		}
		
		blocks[0].attr({ x: blocks[0].attrs.x - dx1, y: blocks[0].attrs.y - dy1 });
		blocks[1].attr({ x: blocks[1].attrs.x + dx2, y: blocks[1].attrs.y - dy2 });
		blocks[2].attr({ x: blocks[2].attrs.x - dx3, y: blocks[2].attrs.y + dy3 });
		blocks[3].attr({ x: blocks[3].attrs.x + dx4, y: blocks[3].attrs.y + dy4 });
		time++;
		return true;
	};
	
	return this;
};

var drawShip = function(type, r, color, offsetX, offsetY) {
	var ship = g_game.raphPaper.set();
	if (type == 'fighter') {
		var points = [
			[ [-r*1.5, -r/2], [r, 0], 	[-r*1.5, r/2] ],
			[ [-r, -r], 	[2*r, 0], 	[-r, r] ]
		];
		for (var j=0;j<points.length;j++) {
			var path = '';
			for (var i=0;i<points[j].length;i++) {
				path += (i == 0 ? 'M' : 'L') + (points[j][i][0] + offsetX) + ',' + (points[j][i][1] + offsetY);
			}
			path += 'L' + (points[j][0][0] + offsetX) + ',' + (points[j][0][1] + offsetY);
			ship.push(g_game.raphPaper.path(path).attr({ fill: color, stroke: '#ddd', 'stroke-width': 3 }));
		}
	}
	else if (type == 'bomber') {
		ship.push(g_game.raphPaper.ellipse(offsetX-r, offsetY-r, r, r/2).attr({ fill: color, stroke: '#ddd', 'stroke-width': 3 }));
		ship.push(g_game.raphPaper.ellipse(offsetX-r, offsetY+r, r, r/2).attr({ fill: color, stroke: '#ddd', 'stroke-width': 3 }));
		ship.push(g_game.raphPaper.ellipse(offsetX, offsetY, 3*r/2, r).attr({ fill: color, stroke: '#ddd', 'stroke-width': 3 }));
	}
	else if (type == 'factory') {
		ship.push(g_game.raphPaper.rect(offsetX - 2, offsetY - 10, 8, 14).attr({ fill: color, stroke: '#ddd', 'stroke-width': 3 }));
		ship.push(g_game.raphPaper.rect(offsetX - 8, offsetY - 4, 8, 8).attr({ fill: color, stroke: '#ddd', 'stroke-width': 3 }));
	}
	
	return ship;
};

var PlayerAI = function(myTeam) {

	var self = this;
	self.team = myTeam;
	self.decisionTicks = 15 + Math.floor(Math.random() * 10);
	
	var count = 0;
	self.move = function() {
		g_game.teams[self.team].routePoints = [];
		destination:
		for (var i in g_game.buildings) {
			// look for my buildings
			if (g_game.buildings[i] && g_game.buildings[i].team == self.team) {
				g_game.teams[self.team].routePoints = [i];
				for (var j in g_game.routes) {
					if (g_game.routes[j].startPlanet == i || g_game.routes[j].endPlanet == i) {
					
						var planet = g_game.routes[j].startPlanet == i ? g_game.routes[j].endPlanet : g_game.routes[j].startPlanet;
					
						// is this planet empty?
						if (!g_game.buildings[planet]) {
							g_game.buildings[i].buildType = 'factory';
							g_game.teams[self.team].routePoints.push(planet);
							break destination;
						}
						else if (g_game.buildings[planet].team != self.team) {
							g_game.buildings[i].buildType = 'bomber';
							g_game.teams[self.team].routePoints.push(planet);
							break;
						
						}
					}
				}
				g_game.buildings[i].buildType = 'fighter';
			}
		}
		
		for (var i=0;i<g_game.ships.length;i++) {
			if (g_game.ships[i].team == self.team)
				g_game.ships[i].setDestination();
		}
	};
	
	return self;
}

var Factory = function(planetName, myTeam) {
	var self = this;

	self.planet = g_game.planets[planetName];
	var frames = 0;
	self.team = myTeam;
	self.buildSpeed = 100;
	self.buildType = 'fighter';
	self.hits = 2;
	var builtByMe = 0;
	self.numShips = 0;
	
	self.image = drawShip('factory', 5, g_defs.teams[self.team].color, self.planet.x, self.planet.y);
	var bbox = self.image.getBBox();
	
	self.progressOutline = g_game.raphPaper.rect(bbox.x, bbox.y + bbox.height, bbox.width, 5)
							.attr({ stroke: '#999', fill: '#333' });
	self.progress = g_game.raphPaper.rect(self.progressOutline.attrs.x + 1, self.progressOutline.attrs.y + 1, 0.1, self.progressOutline.attrs.height-2)
						.attr({ fill: '#0f0', 'stroke-width': 0 });

	if (!self.planet.visible) {
		self.image.hide();
		self.progressOutline.hide();
		self.progress.hide();
 	 }
	 
	if (myTeam == 'team1') {
		self.image.drag(
			function(dx, dy) {
			}, function() {
				//g_game.shipSelector.attr({ cx: self.image.attrs.x + self.image.attrs.width/2, cy: self.image.attrs.y + self.image.attrs.height/2}).show().toFront();
				g_game.shipSelector.transform('t' + (self.image[0].attrs.x + self.image[0].attrs.width/2) + ',' + (self.image[0].attrs.y + self.image[0].attrs.height/2)).show().toFront();
				g_game.shipSelector.game.factory = self;
			}, function() {
				g_game.shipSelector.hide();
			}
		);
	}
	
	self.redraw = function() {
		self.image.attr({ 'stroke-width': self.hits });
	};
	
	self.takeDamage = function(amt) {
		self.hits -= amt;
		if (self.hits <=0)
			self.destroy();
		else
			self.redraw();
	};
	
	self.redraw();
	self.bAlive = true;
	self.destroy = function() {
		if (self.visible) {
			g_game.explosions.push(new Explosion(self.image));
		}
		self.image.remove();
		self.progressOutline.remove();
		self.progress.remove();
		g_game.buildings[planetName] = undefined;
		self.bAlive = false;
	};
	
	self.move = function() {
		if (!self.bAlive) return;
		var w = self.progress.attrs.width;
		frames++;
		// more ships makes factory build slower
		var timeToBuild = self.buildSpeed + Math.pow(2, self.numShips);
		if (frames > timeToBuild) {
			frames = 0;
			g_game.ships.push(new Ship(self.buildType, self.team, self.planet.x, self.planet.y, 3, planetName));
			builtByMe++;
		}
		var newW = (self.progressOutline.attrs.width-2) * frames / timeToBuild;
		if (Math.floor(w) != Math.floor(newW)) {
			self.progress.attr({ width: newW });
		}
	};

	return self;
}

var Route = function(planetA, planetB) {
	this.startPlanet = planetA;
	this.endPlanet = planetB;
	
	var p1 = g_game.planets[planetA];
	var p2 = g_game.planets[planetB];
	
	var bigPath = g_game.raphPaper.path('M' + p1.x + ' ' + p1.y + 'L' + p2.x + ' ' + p2.y);
	this.length = bigPath.getTotalLength();
	this.path = g_game.raphPaper.path(bigPath.getSubpath(p1.r*2, this.length - p2.r*2)).attr( { stroke: '#222', 'stroke-width': 2 }).toBack();
	this.length = this.path.getTotalLength();
	this.image = this.path;
	bigPath.remove();
	
	this.pt1 = this.path.getPointAtLength(0);
	this.pt2 = this.path.getPointAtLength(this.length);
	// find intersecting orbit lengths
	var len = 0;
	while (!this.exitLength1) {
		var orbitPoint = p1.orbit.getPointAtLength(len);
		if (Math.abs(this.pt1.x - orbitPoint.x) < 2 && Math.abs(this.pt1.y - orbitPoint.y) < 2) {
			this.exitLength1 = len;
		}
		len++;
	}
	len = 0;
	while (!this.exitLength2) {
		var orbitPoint = p2.orbit.getPointAtLength(len);
		if (Math.abs(this.pt2.x - orbitPoint.x) < 2 && Math.abs(this.pt2.y - orbitPoint.y) < 2) {
			this.exitLength2 = len;
		}
		len++;
	}
		
	return this;
}

// x and y are center and r is the radius
function getCircleToPath(x, y, r) {
	return "M" + "" + (x) + "," + (y-r) + "A"
		+ r + "," + r + ",0,1,1," + (x-0.1) + "," + (y-r) + "z";
}

var Planet = function(name, myX, myY, myR, myColor) {
	var self = this;
	this.x = myX;
	this.y = myY;
	this.r = myR;
	this.name = name;
	this.orbittingShips = [];
	
	var color = myColor || 'rgb(' + (64 + Math.floor(Math.random() * 128)) + ',' + (64 + Math.floor(Math.random() * 128)) + ',' + (64 + Math.floor(Math.random() * 128)) + ')';
	
	this.orbit = g_game.raphPaper.path(getCircleToPath(this.x, this.y, this.r*2)).attr( { stroke: '#222', 'stroke-width': 2 });
	this.orbitLength = this.orbit.getTotalLength();

	this.image = g_game.raphPaper.circle(myX, myY, myR).attr({ fill: color, 'stroke-width': 3 });

	this.image.hover(
		function() {
			this.attr({ stroke: color });
			if (g_game.routeSelector.game.isActive) {
				var lastPoint = g_game.teams.team1.routePoints[g_game.teams.team1.routePoints.length-1];
				if (lastPoint != self.name) { 
					var bFound = false;
					for (var i=0;!bFound && i<g_levels[g_game.level].routes.length;i++) {
						if (g_levels[g_game.level].routes[i].indexOf(lastPoint) != -1 && g_levels[g_game.level].routes[i].indexOf(self.name) != -1) {
							bFound = true;
						}
					}
					if (bFound) {
						g_game.teams.team1.routePoints.push(self.name);
						for (var i=0;i<g_game.ships.length;i++) {
							if (g_game.ships[i].team == 'team1')
								g_game.ships[i].setDestination();
						}
					}
				}
			}
		}, function() {
			this.attr({ stroke: '#000' });
		}
	);
	
	this.image.drag(
		function(dx, dy, x, y, evt) {
			var path = '';
			for (var i=0;i<g_game.teams.team1.routePoints.length;i++) {
				path += (i == 0 ? 'M' : 'L') + g_game.planets[g_game.teams.team1.routePoints[i]].x 
					+ ' ' + g_game.planets[g_game.teams.team1.routePoints[i]].y;
			}
			path += 'L' + (self.x + dx) + ' ' + (self.y + dy);
			g_game.routeSelector.attr({ path: path });
		}, function(x, y, evt) {
			g_game.teams.team1.routePoints = [name];
			g_game.routeSelector.game.isActive = true;
			g_game.routeSelector.show();
		}, function() {
			g_game.routeSelector.game.isActive = false;
			var path = '';
			for (var i=0;i<g_game.teams.team1.routePoints.length;i++) {
				path += (i == 0 ? 'M' : 'L') + g_game.planets[g_game.teams.team1.routePoints[i]].x 
					+ ' ' + g_game.planets[g_game.teams.team1.routePoints[i]].y;
			}
			// if path is empty, clear all destinations
			if (g_game.teams.team1.routePoints.length == 1) {
				for (var i=0;i<g_game.ships.length;i++) {
					if (g_game.ships[i].team == 'team1' && g_game.ships[i].orbitting) {
						g_game.ships[i].clearDestination();
					}
				}
			}
			g_game.routeSelector.attr({ path: path });
		}
	);
	
	this.addOrbitter = function(orbitter) {
		this.orbittingShips.push(orbitter);
	}
	this.removeOrbitter = function(orbitter) {
		var idx = this.orbittingShips.indexOf(orbitter);
		if (idx >= 0)
			this.orbittingShips.splice(idx, 1);
	}
	
	return this;
};

var Ship = function(myType, myTeam, locX, locY, r, start) {

	var self = this;
	self.type = myType;
	self.home = start;
	if (g_game.buildings[self.home]) {
		g_game.buildings[self.home].numShips += 1;
	}
	self.orbitting = start;
	g_game.planets[self.orbitting].addOrbitter(self);
	self.destination = null;
	self.speed = g_defs.shipStats[this.type].speed;
	self.team = myTeam;
	self.fireSpeed = 20;
	self.hits = g_defs.shipStats[this.type].hits;
	self.damage = g_defs.shipStats[this.type].damage;
	var frames = Math.floor(Math.random() * self.fireSpeed);
	
	self.redraw = function() {
		if (!self.image)
			self.image = drawShip(self.type, 5, g_defs.teams[myTeam].color, 0, 0);

		self.image.attr({ 'stroke-width': self.hits });
		if (!g_game.planets[self.orbitting].visible) {
			self.image.hide();
		}	
	};

	self.redraw();
	self.x = locX;
	self.y = locY;
	//self.image.transform('t' + self.x + ',' + self.y);
	
	
	self.takeDamage = function(amt) {
		self.hits -= amt;
		if (self.hits <= 0)
			self.destroy();
		else
			self.redraw();
	}
	
	self.destroy = function() {
		if (self.visible) {
			g_game.explosions.push(new Explosion(self.image));
		}
		if (self.orbitting) {
			g_game.planets[self.orbitting].removeOrbitter(this);
		}
		var idx = g_game.ships.indexOf(this);
		g_game.ships.splice(idx, 1);
		self.image.remove();
		if (g_game.buildings[self.home])
			g_game.buildings[self.home].numShips -= 1;
	}
	
	self.clearDestination = function() {
		self.exitLength = null;
		self.destination = null;
	};
	
	self.setDestination = function() {
		if (self.orbitting) {
			self.clearDestination();
			for (var i=0;i<g_game.teams[self.team].routePoints.length-1;i++) {
				if (g_game.teams[self.team].routePoints[i] == self.orbitting) {
					// lets go somewhere
					self.destination = g_game.teams[self.team].routePoints[i+1];
				}
			}
			
			if (self.destination) {
				// find a route
				var route = g_game.routes[self.orbitting + '_' + self.destination] || g_game.routes[self.destination + '_' + self.orbitting];
				if (route) {
					//var pt = Raphael.pathIntersection(route.path, g_game.planets[self.orbitting].orbit);
					if (route.startPlanet == self.orbitting) {
						self.exitLength = route.exitLength1;
						self.enterLength = route.exitLength2;
					}
					else {
						self.exitLength = route.exitLength2;
						self.enterLength = route.exitLength1;
					}	
				}
			}
		}
	};
	
	self.setDestination();
	var orbitDistanceTravelled = 0;
	
	self.attackAvailableTargets = function() {
		for (var i=0;i<g_game.planets[self.orbitting].orbittingShips.length;i++) {
			var otherShip = g_game.planets[self.orbitting].orbittingShips[i];
			if (otherShip.team != self.team) {
				if (self.visible) {
					var shot = g_game.raphPaper.path('M' + self.x + ' ' + self.y + 'L' + otherShip.x + ' ' + otherShip.y).attr({ stroke: '#ff5555' });
					setTimeout(function() { shot.remove(); }, 100);
				}
 	 
				if (Math.random() > 0.5)	// needs accuracy
					otherShip.takeDamage(self.damage);
				i = g_game.planets[self.orbitting].orbittingShips.length; // break loop
				if (self.visible) {
					g_game.sounds.laser.play();
				}	
			}
		}
	
	};
	
	self.move = function() {
		frames++;
		if (self.exitLength !== null && Math.abs(orbitDistanceTravelled - self.exitLength) < 2) {
			g_game.planets[self.orbitting].removeOrbitter(this);
			self.orbitting = null;
			self.exitLength = null;
			orbitDistanceTravelled = 0;
		}
		if (self.orbitting) {
			if (self.type == 'factory' && !g_game.buildings[self.orbitting]) {
				// I am orbitting an empty planet, build a factory!
				g_game.buildings[self.orbitting] = new Factory(self.orbitting, self.team);
				return self.destroy();
			}
			orbitDistanceTravelled = (orbitDistanceTravelled + self.speed) % g_game.planets[self.orbitting].orbitLength;
			var pt = g_game.planets[self.orbitting].orbit.getPointAtLength(orbitDistanceTravelled);
			self.x = pt.x;
			self.y = pt.y;
			self.image.transform('t' + self.x + ',' + self.y);
			if (frames % self.fireSpeed == 0) {
				// look for target
				if (self.type == 'fighter') {
					self.attackAvailableTargets();
				}
				else if (self.type == 'bomber') {
					var building = g_game.buildings[g_game.planets[self.orbitting].name];
					if (building && building.team != self.team) {
						if (self.visible) {
							var shot = g_game.raphPaper.path('M' + self.x + ' ' + self.y + 'L' + g_game.planets[this.orbitting].x + ' ' + g_game.planets[this.orbitting].y).attr({ stroke: '#ffffff', 'stroke-width': 3 });
							setTimeout(function() { shot.remove(); }, 100);
							g_game.sounds.bomber.play();
						}
						building.takeDamage(this.damage);
					}
					else {
						self.attackAvailableTargets();
					}
				}
			}
		}
		else if (self.destination) {
			var dx = self.x - g_game.planets[self.destination].x;
			var dy = self.y - g_game.planets[self.destination].y;
			if (Math.abs(dx) < g_game.planets[self.destination].r*2 && Math.abs(dy) < g_game.planets[self.destination].r*2) {
				// we arived!
				if (self.type == 'factory' && g_game.buildings[self.destination] == null) {
					g_game.buildings[self.destination] = new Factory(self.destination, self.team);
					return self.destroy();
				}

				self.orbitting = self.destination;
				g_game.planets[self.orbitting].addOrbitter(this);
				orbitDistanceTravelled = self.enterLength || 0;
				self.setDestination();
				return;
			}
			var angle = Math.atan2(-dy, -dx);
			self.x += self.speed * Math.cos(angle);
			self.y += self.speed * Math.sin(angle);
			// get bbox of set so we can rotate around center
			//for (var i=0;i<self.image.length;i++) {
			var bbox = self.image[self.image.length-1].getBBox();
			self.image.transform('r' + (angle * 180 / Math.PI) + ',' + (bbox.x + bbox.w/2) + ',' + (bbox.y + bbox.h/2));
				self.image.transform('t' + self.x + ',' + self.y);
			//}
			
		}
	};
	
	return this;
};

var doGameLoop = function(frames) {
	var cEnemies = 0;
	var cFriendlies = 0;

	for (var i=0;i<g_game.ships.length;i++) {
		if (g_game.ships[i].team == 'team1') {
			cFriendlies++;
		}
		else {
			cEnemies++;
		}
		g_game.ships[i].move();
	}
	for (var building in g_game.buildings) {
		if (g_game.buildings[building]) {
			if (g_game.buildings[building].team == 'team1') {
				cFriendlies++;
			}
			else {
				cEnemies++;
			}
			g_game.buildings[building].move();
		}
	}
	for (var team in g_game.teams) {
		if (team != 'team1') {
			var player = g_game.teams[team].player;
			if (frames % player.decisionTicks == 0) {
				player.move();
			}
		}
	}
	for (var i=0;i<g_game.explosions.length;i++) {
		if (!g_game.explosions[i].animate()) {
			g_game.explosions.splice(i,1);
			i--;
		}
	}
	
	// check for win or loss
	if (cEnemies == 0) {
		g_game.gameMessage[0].attr({ text: 'You win!' });
		g_game.gameMessage.game.show = true;
		positionGameText();
		g_game.gameMessage.toFront().show();
		if (localStorage.planetary_level == 1) {
			g_game.gameMessage[1].hide();
		}
		
		localStorage.planetary_level = parseInt(localStorage.planetary_level, 10) + 1;
		
		return;
	}
	else if (cFriendlies == 0) {
		g_game.gameMessage[0].attr({ text: 'You lose!' });
		g_game.gameMessage.game.show = true;
		positionGameText();
		g_game.gameMessage.toFront().show();
		g_game.gameMessage[3].hide();
		if (localStorage.planetary_level == 1) {
			g_game.gameMessage[1].hide();
		}

		return;
	}
		
	if (frames % 10 == 0) {
		// check for visibility
		for (var key in g_game.planets) {
			g_game.planets[key].occupied = g_game.planets[key].visible = false;
			if (g_game.buildings[key] && g_game.buildings[key].team == 'team1') {
				g_game.planets[key].occupied = g_game.planets[key].visible = true;
			}
			for (var i=0;i<g_game.planets[key].orbittingShips.length;i++) {
				if (g_game.planets[key].orbittingShips[i].team == 'team1') {
					g_game.planets[key].occupied = g_game.planets[key].visible = true;
				}
			}

			if (g_game.planets[key].visible) {
				g_game.planets[key].image.show();
				g_game.planets[key].orbit.show();
			}
			else {
				g_game.planets[key].image.hide();
				g_game.planets[key].orbit.hide();
			}
		}
		for (var key in g_game.routes) {
			if (g_game.planets[g_game.routes[key].startPlanet].occupied) {
				g_game.routes[key].image.show();
				g_game.routes[key].visible = true;
				g_game.planets[g_game.routes[key].endPlanet].visible = true;
				g_game.planets[g_game.routes[key].endPlanet].image.show();
				g_game.planets[g_game.routes[key].endPlanet].orbit.show();
			}
			else if (g_game.planets[g_game.routes[key].endPlanet].occupied) {
				g_game.routes[key].image.show();
				g_game.routes[key].visible = true;
				g_game.planets[g_game.routes[key].startPlanet].visible = true;
				g_game.planets[g_game.routes[key].startPlanet].image.show();
				g_game.planets[g_game.routes[key].startPlanet].orbit.show();
			}
			else {
				g_game.routes[key].visible = false;
				g_game.routes[key].image.hide();
			}
		}
		for (var key in g_game.buildings) {
			if (g_game.buildings[key] && g_game.planets[key].visible) {
				g_game.buildings[key].visible = true;
				g_game.buildings[key].image.show();
				g_game.buildings[key].progressOutline.show();
				g_game.buildings[key].progress.show();
				g_game.buildings[key].image.show();
			}
			else if (g_game.buildings[key]) {
				g_game.buildings[key].visible = false;
				g_game.buildings[key].image.hide();
				g_game.buildings[key].progressOutline.hide();
				g_game.buildings[key].progress.hide();
			}
		}

		for (var i=0;i<g_game.ships.length;i++) {
			if (g_game.ships[i].orbitting && g_game.planets[g_game.ships[i].orbitting].visible) {
				g_game.ships[i].visible = true;
				g_game.ships[i].image.show();
			}
			else if (!g_game.ships[i].orbitting && g_game.ships[i].destination && g_game.planets[g_game.ships[i].destination].visible) {
				g_game.ships[i].visible = true;
				g_game.ships[i].image.show();
			}
			else {
				g_game.ships[i].visible = false;
				g_game.ships[i].image.hide();
			}
		}
	}
	
	setTimeout(function() { doGameLoop(frames + 1); }, 50);
};

function positionGameText() {
	if (g_game.gameMessage.game.show) {
		for (var i=0;i<g_game.gameMessage.length;i++) {
			g_game.gameMessage[i].attr({ 	x: g_game.background.game.vx + g_game.raphPaper.width/2 + g_game.gameMessage.game.positions[i][0], 
											y: g_game.background.game.vy + g_game.raphPaper.height/2 + g_game.gameMessage.game.positions[i][1] });
		}
	}
	if (g_game.tutorial_set) {
		g_game.tutorial_set.attr( { x: g_game.background.game.vx + g_game.raphPaper.width - 440, y: g_game.background.game.vy + 40 } );
		var text = g_game.tutorial_set[0];
		text.attr( { x: text.attrs.x + text.game.tx, y: text.attrs.y + text.game.ty } );
	}
}

		</script>
		
	</head>
	
	<body bgcolor="#000000" style="background-image:url(./images/background.png)">
		<table align="center">
			<tr>
				<td id="tdGameArea"><div id="gameHolder"></div></td>
			</tr>
		</table>
	
	
	</body>
</html>
